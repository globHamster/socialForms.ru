<style>

    table.TableOfNumbers{
        border: 1px solid black;
        border-collapse: collapse;
    }

    table.TableOfNumbers > tr {
        border: 1px solid black;
    }

    th {
        background-color: #008dd2;
        border: 1px solid black;
        width: 150px;
        text-align: center;
        color: #fff;
    }

    td {
        text-align: center;
        height: 30px;
        border: 1px solid black;
    }

        td.PanelTable {
            border: 1px solid black;
            background-color: grey;
            position: absolute;
            left: 20px;
            width: 100px;
            height: 30px;
        }

    .IsCheckedTR {
        background-color: grey !important;
    }

    .context-menu {
        position: absolute; /* Задаем абсолютное позиционирование для нашего меню */
        display: none; /* Изначально не показываем его */
        background-color: #fff; /* Цвет фона меню */
        border: 1px solid #333; /* Граница */
        /* Немного красивостей. Добавляем тень для нашего меню, что бы отобразить его слегка выше остальных элементов страницы: */
        -moz-box-shadow: -5px 2px 10px rgba(0,0,0,0.5); /* Для Firefox */
        -webkit-box-shadow: -5px 2px 10px rgba(0,0,0,0.5); /* Для Safari и Chrome */
        box-shadow: -5px 2px 10px rgba(0,0,0,0.5); /* Параметры тени */
    }

        /* Добавляем стили для списка которые будет находиться внутри меню и, собственно, содержать его пункты: */
        .context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

            .context-menu ul li {
                margin: 0;
                padding: 0;
                background-color: #fff;
                display: block;
            }

                /* Стили для ссылок пунктов меню: */
                .context-menu ul li a {
                    color: #333;
                    text-decoration: none;
                    font-size: 12px;
                    display: block;
                    padding: 5px;
                }

                    .context-menu ul li a:hover {
                        background-color: #eee;
                    }
    input#fileExcel {
        display: none;
    }
div#file-upload{
    width: 150px;
    height: 30px;
    background-color: #008dd2;
    color: #fff;
}
div#file-upload:hover {
    transform: scale(1.1,1.1);
    transition: 0.2s linear;
    box-shadow: 4px 4px black;
}
div#file-upload>label {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.ButtonStyle{
    width: 100px;
    height: 30px;
    background-color: #008dd2;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.ButtonStyle:hover{
    transform: scale(1.1,1.1);
    transition: 0.2s linear;
    box-shadow: 4px 4px black;
    border: 0px;
}
</style>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
@Scripts.Render("~/Scripts/jquery.maskedinput.js")
<div class="PanelOfNumbers" style="display: inline-flex; margin-bottom: 3px;">
<div id="file-upload">
    <label>
        <input type="file" name="fileExcel" id="fileExcel">
        <span>Выберите файл</span>
    </label>
</div><div style="width:3px;"></div>
<div class="ButtonStyle" onclick="ExportCSV()">Экспорт</div><div style="width:3px;"></div>
<div style="width: 150px;" class="ButtonStyle" onclick="AddNewTable()">Добавить таблицу</div><div style="width:3px;"></div>
<div style="width: 150px;" class="ButtonStyle" onclick="DeleteTable()">Удалить таблицу</div><div style="width:3px;"></div>
<div style="width: 150px;" class="ButtonStyle" onclick="ClearTable()">Очистить таблицу</div>
<div class="BlockPanel" style="display: none; position: absolute; top:0; left:0; width: 100%; height:40px; background-color:rgba(100,100,100,0.5);"></div>
    </div>
<table class="TableOfNumbers" style="width:100%;" cellspacing="0">
    <tr>
        <th style="width:30px;">
        <th>Таблица</th>
        <th>Название</th>
        <th>Количество</th>
        <th>Дозвоны</th>
        <th>Перезвонить</th>
        <th>Нет ответа</th>
        <th>Занято</th>
        <th>Осталось</th>
        <th>Процент дозвона</th>
    </tr>
</table>

@*<button onclick="ExportCSV()">Export</button>
<button onclick="AddNewTable()">Add New Table</button>
<button onclick="DeleteTable()">Delete Table</button>
<button onclick="ClearTable()">Clear Table</button>*@
<script>

    function Recolor() {
        var count = 0;
        $('.TableOfNumbers').find("tr:not(:first)").each(function () {
            if ((count%2) == 1) {
                console.log("Recolor");
                $(this).css("background-color", "#b0bec5"); 
            }
            count++;
        })
    }

    function ClearTable() {
        ExportCSV();
        if ($('table.TableOfNumbers').find('.IsCheckedTR').length != 0) {
            var id = Number($('table.TableOfNumbers').find('.IsCheckedTR').attr('id'))
            alert(id);
            $.post("/Home/ClearTable", { id: id })
                .success(function () {
                    $('table.TableOfNumbers').find("tr[id=" + id + "]").find("td:not(:eq(0)):not(:eq(0))").each(function () {
                        $(this).empty();
                    })
                })
                .error(function (err) { alert(err); })
        } else {
            alert("Выберите таблицу");
        }
    }

    function DeleteTable() {
        var id = Number($('.TableOfNumbers').find("tr:last").attr('id'));
        if (id <= 10) {
            alert("Ограничение по удалению таблиц");
        } else {
            if ($('table.TableOfNumbers').find("tr[id=" + id + "]").find("td[name=NameFile]").text() != "") {
                alert("Выгрузите таблицу");
            } else {
                $('.BlockPanel').css("display", "flex");
                $.post("/Home/DeleteTable", { id: id })
                    .success(function () {
                        $('table.TableOfNumbers').find("tr[id=" + id + "]").remove();
                        $('.BlockPanel').css("display", "none");
                    })
                    .error(function () { alert("Error"); })
            }
        }
    }

    function AddNewTable() {
        $('.BlockPanel').css("display", "flex");
        var id = Number($('.TableOfNumbers').find("tr:last").attr('id'));
        $.post("/Home/CreateNewTable", { id: id })
            .success(function () {
                $('table.TableOfNumbers').append(`
                        <tr name="table`+ (id + 1) + `" id="` + (id + 1) + `">
                            <td><input type="checkbox" /></td>
                            <td>Таблица `+ (id + 1) + `</td>
                            <td name="NameFile"></td>
                            <td name="Common"></td>
                            <td name="Connect"></td>
                            <td name="Recall"></td>
                            <td name="Not_answer"></td>
                            <td name="Busy"></td>
                            <td name="Balance"></td>
                            <td name="Percent"></td>
                        </tr>`);
                $('.BlockPanel').css("display", "none");
                Recolor();
            })
            .error(function () { alert("Error") });
    }

   
        $.get("/Home/GetListTable")
            .success(function (data) {
                var tmp_list = [];
                $.each(data, function (i, item) {
                    if (item == "name_table") return;
                    var id_str = item.replace("table", "");
                    tmp_list.push({ Id: Number(id_str), Name: item });
                })
                tmp_list.sort(function (a, b) { return a.Id - b.Id });
                console.log(tmp_list);

                $.each(tmp_list, function (i, item) {
                    $('table.TableOfNumbers').append(`
                        <tr name="`+ item.Name + `" id="` + item.Id + `">
                            <td><input type="checkbox" /></td>
                            <td>Таблица `+ item.Id + `</td>
                            <td name="NameFile"></td>
                            <td name="Common"></td>
                            <td name="Connect"></td>
                            <td name="Recall"></td>
                            <td name="Not_answer"></td>
                            <td name="Busy"></td>
                            <td name="Balance"></td>
                            <td name="Percent"></td>
                        </tr>`)
                })

                $.get("/Home/GetNameTable")
                    .success(function (data) {
                        $.each(data, function (i, item) {
                            if (item.Name != null) {
                                $('.TableOfNumbers tr[id=' + item.Id + ']').find("td[name=NameFile]").text(item.Name);
                                $.get("/Home/GetNumbers", { id: item.Id })
                                    .success(function (data) {
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Common]").text(data.Common);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Connect]").text(data.Connect);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Not_answer]").text(data.Not_answer);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Balance]").text(data.Balance);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Busy]").text(data.Busy);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Recall]").text(data.Recall);
                                        $('.TableOfNumbers tr[name=table' + item.Id + ']').find("td[name=Percent]").text(Math.round((Number(data.Connect) + Number(data.Recall)) * 100 / Number(data.Common)) + "%");
                                    })
                            }
                        })
                    })
                Recolor();
            })

    $('.TableOfNumbers').on("click", "tr", function () {
        $(this).parent().find(".IsCheckedTR").each(function () {
            $(this).removeClass("IsCheckedTR");
        })
        $(this).addClass("IsCheckedTR");

    })

    $('#fileExcel').on("change", function (e) {
        if ($('table.TableOfNumbers').find(".IsCheckedTR").length != 0) {
            var file_elem = $(this);
            if ($('table.TableOfNumbers').find('.IsCheckedTR').find('td[name=NameFile]').text() != "") {
                alert("Таблица уже занята");
                return;
            }
            var files = e.target.files;
            var name_file;
            if (files.length > 0) {
                if (window.FormData !== undefined) {
                    var data = new FormData();
                    for (var x = 0; x < files.length; x++) {
                        data.append("file" + x, files[x]);
                        var file = files[x];
                        name_file = file.name;
                    }
                    data.append("name_table", $('.IsCheckedTR').attr('name'));
                    $('.TableOfNumbers').find(".IsCheckedTR").find("td[name=NameFile]").text(name_file);
                    var table_name = $('.IsCheckedTR').attr('id');
                    $.ajax({
                        type: "POST",
                        url: "/Home/Import?table=" + table_name,
                        contentType: false,
                        processData: false,
                        data: data,
                        success: function (data) {
                            console.log("CallBack >>>>> ", data);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Common]").text(data.Common);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Connect]").text(data.Connect);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Not_answer]").text(data.Not_answer);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Balance]").text(data.Balance);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Busy]").text(data.Busy);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Recall]").text(data.Recall);
                            $('.TableOfNumbers tr[name=table' + table_name + ']').find("td[name=Percent]").text(Math.round((Number(data.Connect) + Number(data.Recall)) * 100 / Number(data.Common)) + "%");
                            file_elem.val("");
                        }
                    })
                    alert("File not null");
                } else {
                    alert("This browser doesn't support HTML5 file uploads!");
                }
            }
        } else {
            alert("Выберите таблицу");
        }
    })

    //function SaveNumber() {
    //    var str = $('input[name=StringNumber]').val();
    //    $.post("/Home/SetNumber", { str_numb: str })
    //        .success(function () {
    //            alert("Number saved");
    //        })
    //        .error(function () {
    //            alert("Error");
    //        });
    //}

    function ClearTableButton() {
        $.post("/Home/ClearTable")
            .success(function () {
                alert("Success");
            })
            .error(function () {
                alert("Error");
            })
    }

    setInterval(function () {
        $('.TableOfNumbers').find("tr:not(:first)").each(function () {
            if ($(this).find("td[name=NameFile]").text() != "") {
                console.log($(this).attr("name"));
                var id = $(this).attr('id');
                $.get("/Home/GetNumbers", { id: $(this).attr('id') })
                    .success(function (data) {
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Common]").text(data.Common);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Connect]").text(data.Connect);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Not_answer]").text(data.Not_answer);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Balance]").text(data.Balance);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Busy]").text(data.Busy);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Recall]").text(data.Recall);
                        $('.TableOfNumbers tr[name=table' + id + ']').find("td[name=Percent]").text(Math.round((Number(data.Connect) + Number(data.Recall)) * 100 / Number(data.Common)) + "%");
                    })
            }
        })
    }, 60000)

    function ExportCSV() {
        if ($('.TableOfNumbers').find('.IsCheckedTR').length != 0) {
            var id = $('.TableOfNumbers').find(".IsCheckedTR").attr('id');
            console.log(id)
            window.location.href = "/Home/ExportToCSV?id=" + id;
        }
    }
</script>
