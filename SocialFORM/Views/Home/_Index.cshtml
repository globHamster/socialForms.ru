@{
    ViewBag.Title = "Личный кабинет";
}
<div class="row">
    <div class="col-md-3">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <h3>
                        Добро пожаловать :
                    </h3>
                </div>
                <div class="row">
                    <div name="operatorID" id="@ViewBag.operator_id" style="display: none;"></div>
                    <img id="status" src="~/images/icon/status.png" /><p class="name_operator" style="display: inline;">
                        @ViewData["Family"] @ViewData["Name"]
                    </p>
                    
                    <p>
                        (@ViewData["Role"])
                    </p>
                    <p class="lead" style="display:none">
                        <span class="label label-warning" id="seconds" style="display:none">00</span> @*Таймер о начале сна*@
                        <div id="result2" style="display:none">(^_^) Hey, there.</div>
                        <span id="result3" class="badge badge-info" style="display:none">0</span>
                    </p>
                    <div id="result" style="display:none">
                        <p>Event log.</p>
                    </div>
                    <script type="text/javascript">
                        var dur = (ifvisible.getIdleDuration() / 1000);
                        d('seconds').innerHTML = dur;
                        d('idleTime').innerHTML = dur + " seconds";
                    </script>
                </div>
                <div class="row">
                    <p>
                        Инфо. блок
                        @ViewData["test"]
                    </p>
                </div>
                <div class="row">
                    <div class="col-md-6" id="timedisplay">

                    </div>
                    <div class="col-md-6">
                        @Html.ActionLink("Выйти", "Logoff", "Account")
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <h3>Меню</h3>
            @Html.Action("Menu", "Home")
        </div>
    </div>
    <div class="col-md-9">
        <div id="Tables" class="Tables">

        </div>
    </div>
</div>


<script src="~/Scripts/ifvisible.js" type="text/javascript"></script>
<script type="text/javascript">
    var root = window.addEventListener || window.attachEvent ? window : document.addEventListener ? document : null;
    if ('@ViewData["Role"]' == 'Operator') {
        if (root) {
            root.onbeforeunload = function () {
                $.post("/Account/Logofff");
                return 'Exit';
            }
        }
    }
    else {
        if (root) {
            root.onbeforeunload = function () {
                return 'Exit';
            }
        }
    }
    //
    //Таймер активности
    //
    function d(el) {
        return document.getElementById(el);
    }
    ifvisible.setIdleDuration(1800);

    ifvisible.on('statusChanged', function (e) {
        d("result").innerHTML += (e.status + "<br>");
        if (e.status == "idle") {
            $('img[id=status]').attr('src', '../images/icon/status_busy.png');
        }
        else {
            $('img[id=status]').attr('src', '../images/icon/status.png');
        }
    });

    ifvisible.idle(function () {
        d("result2").innerHTML = "(-_-) Good bye. ZzzZZzz...";
        $.post("/Account/getTimeOut", { time: d("result3").innerText, userId: "@ViewBag.operator_id"})
    });

    ifvisible.wakeup(function () {
        d("result2").innerHTML = "(O_o) Hey!, you woke me up.";

        $.post("/Account/getSetTimeUp", { time: $("#timedisplay").text(), userId: "@ViewBag.operator_id" })
    });

    ifvisible.onEvery(0.5, function () {
        // Clock, as simple as it gets
        var h = (new Date()).getHours();
        var m = (new Date()).getMinutes();
        var s = (new Date()).getSeconds();
        h = h < 10 ? "0" + h : h;
        m = m < 10 ? "0" + m : m;
        s = s < 10 ? "0" + s : s;
        // Update clock
        d("result3").innerHTML = (h + ':' + m + ':' + s);
    });

    setInterval(function () {
        var info = ifvisible.getIdleInfo();
        // Give 3% margin to stabilaze user output
        if (info.timeLeftPer < 3) {
            info.timeLeftPer = 0;
            info.timeLeft = ifvisible.getIdleDuration();
        }
        d("seconds").innerHTML = parseInt(info.timeLeft / 1000), 10;
        //d("idlebar").style.width = info.timeLeftPer + '%';
    }, 100);

    function getDate() {
        var date = new Date();
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        //По надобности условие ниже повторить с minutes и hours
        if (seconds < 10) {
            seconds = '0' + seconds;
        }
        document.getElementById('timedisplay').innerHTML = hours + ':' + minutes + ':' + seconds;
    }
    setInterval(getDate, 0);


</script>
