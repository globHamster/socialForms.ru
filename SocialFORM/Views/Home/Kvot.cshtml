<link href="~/Content/jquery-ui.min.css" rel="stylesheet" />
<style>
    .check_question{
        padding: 5px;
        background-color: #58e863;
        width: 100px;
    }
    .PanelQuestion {
        padding: 10px;
        position: absolute;
        min-width: 150px;
        display: none;
        align-items:center;
    }
    p.hover_question {
        text-align: center;
        margin-left: 5%;
        width: 90%;
    }
    p.hover_question:hover{
        border: 1px solid black;
        box-shadow: 5px 5px black;
    }
    .QuotaPanel {
        border: 1px solid black;
        box-shadow: 3px 3px 5px black;
        margin: 5px;
        padding: 5px;
    }
    .name_quota_question {
        display: inline-block;
        border: 1px solid black;
        width: 50%;
        margin-left: 10px;
        padding: 5px;
    }
    .TargetAnswerPanel{
        border: 1px solid black;
        padding: 5px;
        margin: 5px;
    }
    .UnionWith {
        display: inline-block;
        margin-left: 5px;
        padding: 5px 15px;
        background-color: #58e863;
    }
    .UnionWith:hover{
        background-color: grey;
        border: 1px solid black;
    }
    .QuotaHeadName {
        font-weight: 600;
    }
    .SpaceArrow {
        display: inline-block;
        color: #72afff;
        font-size: 24px;
        margin-left: 10px;
    }
    .RemoveLevelQuota {
        display: inline-block;
        color: gray;
        background-color: #dd6565;
        width: 30px;
        margin-left: 5px;
        text-align: center;
        padding: 5px;
    }
    .RemoveLevelQuota:hover{
        color: red;
    }
    .QuotaLastName {
        width: 350px;
        display: inline-block;
        font-weight: normal;
    }
    .SaveQuota {
        width: 120px;
        height: 30px;
        padding: 5px;
        text-align: center;
        background-color: #72afff;
        color: black;
        font-weight: 600;
    }
    .SaveQuota:hover {
        color: #585858;
    }
</style>
<input name="project_id" value="@ViewBag.ProjectID" hidden/>
<div class="kvot_panel">
    <select class="type_kvot">
        <option value="1">Квота по полу</option>
        <option value="2">Квота по возрасту</option>
    </select>
    <select name="question_name">
        <option disabled>Выберите вопрос</option>
    </select>
    <div class="answer_type"></div>
    <button onclick="SaveKvot()">Сохранить</button>
    <div class="list_all_kvot" style="margin-top: 25px">

    </div>
</div>

<div class="check_question"> Выберите вопрос </div>
<div class="PanelQuestion" id="PanelQuestion"> </div>
<div class="QuotaPanel"></div>
<div class="SaveQuota">&#10004; Сохранить</div>
<script src="~/Scripts/jquery-ui.js"></script>
<script type="text/javascript">
    let project_id = $('input[name=project_id]').val();
    let list_kvot = {};
    let list_group_question = {};
    let list_kvot_question = {};
    $(function () {

        $.get("/Group/getGroup", { id_p: project_id })
            .success(function (server_data) {
                $.each(server_data, function (i, item) {
                    list_group_question[item.QuestionID] = item;
                })
            })
        

        $.get("/Question/GetListKvot", { id_p: project_id })
            .success(function (server_data) {
                $.each(server_data, function (i, item) {
                    if (list_kvot[item.QuestionID] == undefined) {
                        list_kvot[item.QuestionID] = [item];
                    } else {
                        list_kvot[item.QuestionID].push(item);
                    }
                })
                $.each(list_kvot, function (i, item) {
                    $('div.list_all_kvot').append('<h3>Квот</h3>');
                    $('div.list_all_kvot').append('<div id="'+i+'"></div>');
                    $.each(item, function (i, item_2) {
                        $('div.list_all_kvot').find('div:last').append('<p id="' + item_2.Id + '">' + item_2.Target + '<input type="text" value="' + item_2.CountKvot + '" /></p>');
                    })
                })
                $('div.list_all_kvot').find('div').each(function () {
                    $(this).append('<button class="save_kvot" id="'+ $(this).attr('id')+'">Save</button>');
                    $(this).append('<button class="delete_kvot" id="'+$(this).attr('id')+'">Delete</botton>');
                })
                $('div.list_all_kvot').accordion();
            });



        $.get('/Question/GetListQuestionKvot', { id_p: project_id })
            .success(function (server_data) {
                $.each(server_data, function (i, item) {
                    $('select[name=question_name]').append('<option value=' + item.Id + '> Вопрос ' + item.Id + '</option>');
                    $('div.PanelQuestion').append('<p class="hover_question" id="' + item.Id + '">Вопрос ' + item.Id + '</p>');
                    list_kvot_question[item.Id] = item;
                    var id_question = item.Id;
                    $.get("/Question/getAnswer", { id_question: id_question })
                        .success(function (server_data) {
                            $.each(server_data, function (i, item) {
                                if (list_kvot_question[id_question].AnswerList == undefined) {
                                    list_kvot_question[id_question].AnswerList = [item];
                                } else {
                                    list_kvot_question[id_question].AnswerList.push(item);
                                }

                            })
                        })
                })
                console.log("Full list question === ", list_kvot_question);
            })

        $('select[name=question_name]').change(function () {
            var id_question = $('select[name=question_name] option:checked').val();
            $('div.answer_type').empty();
            $.get("/Question/getAnswer", { id_question: id_question })
                .success(function (server_data) {
                    var sublist_kvot = {};
                    //$.each(list_kvot[id_question], function (i, item) {
                    //    sublist_kvot[item.Target] = item;
                    //});
                    $.each(server_data, function (i, item) {
                        $('div.answer_type').append('<p id="' + item.Id + '"><span style="margin-right: 10px;">' + item.AnswerText + '</span><input type="text" /></p>');
                       
                    })
                })


        })

    })

    function SaveKvot() {
        var type_kvot = $('select.type_kvot option:checked').val();
        var id_question = $('select[name=question_name] option:checked').val();
        var answer_mas = {};
        var kvot_massive = [];
        $('div.answer_type p').each(function () {
            var query = {
                ProjectID: project_id,
                QuestionID: id_question,
                Target: $(this).find('span').text(),
                CountKvot: $(this).find('input').val(),
                TypeKvot: $('select.type_kvot option:checked').val()
            }
            kvot_massive.push(query);
        })
        $.post("/Question/SetKvot", { _kvot: kvot_massive })
            .success(function () {
                $('.Tables').empty();
                $('.Tables').load('/Home/Kvot?id_p=' + project_id);
            });
        
    }

    $('div.list_all_kvot').on("click", ".delete_kvot", function () {
        var id_question = $(this).attr('id');
        var div_kvot = $(this).parent();
        var h3_kvot = div_kvot.prev();
        div_kvot.remove();
        h3_kvot.remove();
        $.post("/Question/DeleteKvot", { id_question: id_question });
    })

    $('div.list_all_kvot').on("click", ".save_kvot", function () {
        var id_question = $(this).attr('id');
        var div_kvot = $(this).parent();
        var list_new_changes = [];
        div_kvot.find('p').each(function () {
            list_new_changes.push($(this).attr('id') + "#" + $(this).find('input').val());
        })
        $.post("/Question/ChangeKvot", { new_changes: list_new_changes });
    })

    $('.check_question').click(function (event) {
        var position_x = this.offsetLeft + Math.floor(this.offsetWidth / 2);
        var position_y = this.offsetTop + Math.floor(this.offsetHeight / 2);
        this.style.backgroundColor = "grey";
        this.style.boxShadow = "0px 0px black";
        $('.check_question').animate({ backgroundColor: '#58e863' }, 200);
        var panel_question_div = document.getElementById('PanelQuestion');
        panel_question_div.style.display = 'block';
        //panel_question_div.style.position = 'fixed';
        panel_question_div.style.left = position_x + "px";
        panel_question_div.style.top = position_y + "px";
        panel_question_div.style.backgroundColor = "#72afff";
        $(document).mouseup(function (event) {
            var container = $('.PanelQuestion');
            if (container.has(event.target).length === 0) {
                container.hide();
            }
        });
    })

    

    $('.PanelQuestion').on("click", 'p.hover_question', function () {
        //alert($(this).attr('id'));
        $(this).parent().slideUp(200);
        $(this).hide();
        if ($(this).parent().hasClass('NewLevel')) {
            $('.AddNewLevel').after('<div name="quota_question_manager" class="QuotaManager Child" id="' + $(this).attr('id') + '"><div class="SpaceArrow">&#10148;</div><div class="name_quota_question">' + list_group_question[$(this).attr('id')].GroupName + '</div><div class="RemoveLevelQuota Child" id="' + $(this).attr('id') + '">&#10006;</div><div class="UnionWith Child"> &#10010; Уровень</div></div>');
            $('.AddNewLevel').removeClass('AddNewLevel');
            BildQuotaTree();
        } else {
            $('.QuotaPanel').append('<div name="quota_question_manager" id="' + $(this).attr('id') + '" class="QuotaManager Root"><div class="name_quota_question">' + list_group_question[$(this).attr('id')].GroupName + '</div><div class="RemoveLevelQuota Root" id="' + $(this).attr('id') + '">&#10006;</div><div class="UnionWith Root"> &#10010; Уровень</div></div>');
            $('div[id=' + $(this).attr('id') + '][name=quota_question_manager]').append('<div class="TargetAnswerPanel"></div>');
            var id_question = $(this).attr('id');
            $.get("/Question/getAnswer", { id_question: $(this).attr('id') })
                .success(function (server_data) {
                    var sublist_kvot = {};
                    //$.each(list_kvot[id_question], function (i, item) {
                    //    sublist_kvot[item.Target] = item;
                    //});
                    $.each(server_data, function (i, item) {
                        $('div[id=' + id_question + '][name=quota_question_manager]').find('.TargetAnswerPanel').append('<p id="' + item.Id + '"><span style="margin-right: 10px;">' + item.AnswerText + '</span><input type="text" /></p>');

                    })
                })
        }
    })

    $('.QuotaPanel').on("click", '.UnionWith', function () {
        //var list_target_answer = [];
        //$(this).parent().find('.TargetAnswerPanel').find('p').each(function () {
        //    list_target_answer.push($(this).find('span').text());
        //})
        //var next_div = $(this).parent().next();
        //$(this).parent().find('.TargetAnswerPanel').remove();
        //var html_target = next_div.find('.TargetAnswerPanel').html();
        //next_div.find('.TargetAnswerPanel').remove();
        //$.each(list_target_answer, function (i, item) {
        //    next_div.append('<div>' + item + '<div style="margin-left: 20px"> ' + html_target + '</div></div>');
        //})
        if ($(this).hasClass('Root')) {
            $(this).parent().addClass('Rebild');
        }
        if ($(this).hasClass('Child')) {
            $(this).parents('.Root').addClass('Rebild');
        }
        $('.PanelQuestion').addClass('NewLevel');
        $(this).addClass('AddNewLevel');
        var position_x = this.offsetLeft + Math.floor(this.offsetWidth / 2);
        var position_y = this.offsetTop + Math.floor(this.offsetHeight / 2);
        this.style.backgroundColor = "grey";
        this.style.boxShadow = "0px 0px black";
        $('.check_question').animate({ backgroundColor: '#58e863' }, 200);
        var panel_question_div = document.getElementById('PanelQuestion');
        panel_question_div.style.display = 'block';
        //panel_question_div.style.position = 'fixed';
        panel_question_div.style.left = position_x + "px";
        panel_question_div.style.top = position_y + "px";
        panel_question_div.style.backgroundColor = "#72afff";
        $(document).mouseup(function (event) {
            var container = $('.PanelQuestion');
            if (container.has(event.target).length === 0) {
                container.hide();
                container.removeClass('NewLevel');
            }
        });
    })


    $('.QuotaPanel').on("click", ".RemoveLevelQuota", function () {
        var id_question = $(this).attr('id');
        if ($(this).hasClass('Root')) {
            $(this).parent().addClass('Rebild');
            $('.PanelQuestion').find('p[id=' + id_question + ']').show();
            $(this).parent().remove();
        }
        if ($(this).hasClass('Child')) {
            $(this).parents('.Root').addClass('Rebild');
            $('.PanelQuestion').find('p[id=' + id_question + ']').show();
            $(this).parent().remove();
            BildQuotaTree();
        }
       
    })

    function BildQuotaTree() {
        var container_rebild = $('.Rebild');
        container_rebild.find('.TargetAnswerPanel').empty();
        var massiv_tmp = [];
        massiv_tmp.push(container_rebild.attr('id'));
        //alert(container_rebild.attr('id'));
        container_rebild.find('div.QuotaManager').each(function () {
            massiv_tmp.push($(this).attr('id'));
        })

        console.log("Massive tmp : ", massiv_tmp);
        for (var i = 0; i < massiv_tmp.length; i++) {
            var question_item = list_kvot_question[massiv_tmp[i]];
            console.log("Question list === ", question_item);
            if (i == massiv_tmp.length - 1) {
                var list_answer = question_item.AnswerList;
                console.log('List answer === ', list_answer);
                if (massiv_tmp.length == 1) {
                    $.each(list_answer, function (k, item) {
                        container_rebild.find('.TargetAnswerPanel').append('<div style="margin-left: ' + (10 * i) + 'px; border-bottom: 1px solid grey;"><div class="QuotaLastName" id=' + i + ' ><input type="hidden" class="InfoAnswer" id="' + item.Id + '" value="' + item.AnswerText + '" /><input type="hidden" class="InfoQuestion" id="' + question_item.Id + '"/>' + item.AnswerText + '</div><div style="display:inline-block; margin-bottom: 3px;"><input type="text" style=" width: 80px;" /></div></div>');
                    })
                }
                else {
                    $.each(list_answer, function (k, item) {
                        container_rebild.find('.TargetAnswerPanel').find('div[id=' + (i - 1) + ']').each(function () {
                            $(this).append('<div style="margin-left: ' + (10 * i) + 'px; border-bottom: 1px solid grey;"><div class="QuotaLastName" id=' + i + ' ><input type="hidden" id="' + item.Id + '" value="' + item.AnswerText + '" /><input type="hidden" class="InfoQuestion" id="' + question_item.Id + '"/>' + item.AnswerText + '</div><div style="display:inline-block; margin-bottom: 3px;"><input type="text" style=" width: 80px;" /></div></div>');
                        })
                    })
                }
            } else if (i == 0) {
                var list_answer = question_item.AnswerList;
                console.log('List answer === ', list_answer);
                $.each(list_answer, function (k, item) {
                    container_rebild.find('.TargetAnswerPanel').append('<div class="QuotaHeadName" id=' + i + '><input type="hidden" id="' + item.Id + '" value="' + item.AnswerText + '" /><input type="hidden" class="InfoQuestion" id="' + question_item.Id + '"/>' + item.AnswerText + '</div>');
                })
            } else {
                var list_answer = question_item.AnswerList;
                console.log('List answer === ', list_answer);
                $.each(list_answer, function (k, item) {
                    container_rebild.find('.TargetAnswerPanel').find('div[id=' + (i - 1) + ']').each(function () {
                        $(this).append('<div class="QuotaHeadName" id=' + i + ' style="margin-left: ' + (10 * i) + 'px"><input type="hidden" id="' + item.Id + '" value="' + item.AnswerText + '" /><input type="hidden" class="InfoQuestion" id="' + question_item.Id + '"/>' + item.AnswerText + '</div>');
                    })
                })
            }
        }
        $('.Rebild').removeClass('Rebild');
    }

    $('.SaveQuota').click(function () {
        if ($('.QuotaManager').length > 0) {
            $('.TargetAnswerPanel').find('input').each(function () {
                if ($(this).val() == '') {
                    $(this).val(0);
                }
            })
            var list_manager_quota = $('.QuotaManager').filter('.Root');
            var list_id_question = [];
            list_manager_quota.each(function (i) {
                list_id_question[i] = String($(this).attr('id'));
                $(this).find('.Child').filter('.QuotaManager').each(function () {
                    list_id_question[i] += ("#" + $(this).attr('id'));
                })
            })

            console.log("List id question === ", list_id_question);
        } else {
            alert("Список квот пуст!");
        }
    })

    function CreateChainQuota(id_num) {
        //var full_chain = new String();
        if ($('.TargetAnswerPanel').find()) {

        } else {
            $.each()
        }

    }
</script>



